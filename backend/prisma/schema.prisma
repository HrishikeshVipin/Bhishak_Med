// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Using String with defaults for compatibility
// UserRole: "DOCTOR" | "ADMIN"
// DoctorStatus: "PENDING_VERIFICATION" | "VERIFIED" | "REJECTED" | "SUSPENDED"
// ConsultationStatus: "ACTIVE" | "COMPLETED" | "CANCELLED"
// SubscriptionStatus: "TRIAL" | "ACTIVE" | "EXPIRED" | "CANCELLED"
// SubscriptionTier: "TRIAL" | "BASIC" | "PROFESSIONAL" | "ENTERPRISE"
// MedicineCategory: "AYURVEDA" | "HOMEOPATHY" | "ALLOPATHY" | "UNANI" | "SIDDHA" | "GENERAL"
// SubscriptionHistoryStatus: "ACTIVE" | "COMPLETED" | "CANCELLED"

// Admin model (created via seed script)
model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  fullName  String
  role      String   @default("ADMIN") // "SUPER_ADMIN" | "ADMIN"

  // SUPER_ADMIN: Full access to everything + manage other admins
  // ADMIN: Limited access (configurable permissions)

  // Permissions (JSON array of permission strings)
  // Super Admin has all permissions by default
  // Regular Admin permissions controlled by Super Admin
  permissions Json?  // ["VALIDATE_DOCTORS", "VIEW_PATIENTS", "VIEW_ANALYTICS", etc.]

  // Status
  isActive  Boolean  @default(true)
  lastLogin DateTime?

  // Notification preferences
  emailNotifications Boolean @default(true)

  // T&C Acceptance
  termsAcceptedAt      DateTime?
  termsVersion         String?   @default("v1.0")
  privacyPolicyAccepted Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role, isActive])
}

// Doctor model
model Doctor {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String   // bcrypt hashed
  fullName       String
  phone          String
  specialization String

  // Medical Registration (State OR National)
  registrationType  String  // "STATE_MEDICAL_COUNCIL" or "NATIONAL_MEDICAL_COMMISSION"
  registrationNo    String  // Registration number
  registrationState String? // Required if registrationType is STATE (e.g., "Maharashtra", "Delhi")

  // Aadhaar verification
  aadhaarNumber String // 12-digit Aadhaar number

  // KYC Documents (File paths to uploaded files)
  registrationCertificate String? // Medical registration certificate
  aadhaarFrontPhoto       String? // Aadhaar card front photo
  aadhaarBackPhoto        String? // Aadhaar card back photo
  profilePhoto            String? // Doctor's profile photo
  digitalSignature        String? // Doctor's signature image for prescriptions

  // Verification status
  status          String  @default("PENDING_VERIFICATION") // DoctorStatus
  rejectionReason String? // Reason if rejected by admin

  // UPI Payment Info (for patients to pay directly)
  upiId       String? // UPI ID for payments
  qrCodeImage String? // File path to QR code image

  // Trial & Subscription
  trialStartDate     DateTime @default(now())
  trialEndsAt        DateTime // 14 days from signup
  patientsCreated    Int      @default(0) // Max 2 during trial
  subscriptionStatus String   @default("TRIAL") // SubscriptionStatus
  subscriptionEndsAt DateTime?

  // Subscription Tier & Limits
  subscriptionTier   String   @default("TRIAL") // SubscriptionTier
  patientLimit       Int      @default(2) // Based on subscription tier (-1 for unlimited)

  // Video Minutes Tracking
  monthlyVideoMinutes Int      @default(100) // Base quota from subscription
  purchasedMinutes    Int      @default(0) // Extra minutes purchased (carry over)
  totalMinutesUsed    Int      @default(0) // Current cumulative usage
  lastResetDate       DateTime @default(now()) // For monthly quota reset

  // Razorpay Subscription
  razorpaySubscriptionId String? @unique
  razorpayCustomerId     String? @unique

  // Prescription serial numbering
  lastPrescriptionSerial Int @default(0)

  // Patient self-registration
  allowSelfRegistration Boolean @default(true)

  // Current subscription history reference
  currentSubscriptionHistoryId String? @unique

  // Notification preferences
  emailNotifications Boolean @default(true)
  chatNotifications  Boolean @default(true)

  // Phase 2: Doctor Discovery & Profile
  doctorType      String   @default("ALLOPATHY") // "ALLOPATHY" | "AYURVEDA" | "HOMEOPATHY"
  subspecialty    String[] // Array of sub-specializations
  languagesSpoken String[] // ["English", "Hindi", "Malayalam"]
  yearsExperience Int?
  consultationFee Int?     // In paise
  bio             String?  @db.Text
  profileComplete Boolean  @default(false)

  // Phase 2: Online Status Tracking
  isOnline     Boolean   @default(false)
  lastSeen     DateTime?
  availability Json?     // Weekly schedule: { "monday": { "start": "09:00", "end": "17:00" }, ... }

  // Phase 2: Aggregated Ratings (denormalized for performance)
  totalReviews  Int      @default(0)
  averageRating Decimal? @default(0) @db.Decimal(3, 2)

  // Phase 2: Appointment Scheduling
  appointmentBuffer   Int @default(5) // Minutes between appointments
  defaultSlotDuration Int @default(30) // 15, 30, or 60 minutes

  // Phase 2: Referral Credits
  referralCredits Int @default(0) // Total credits earned from referrals

  // SECURITY: Terms & Conditions Acceptance
  termsAcceptedAt       DateTime?
  termsVersion          String?   @default("v1.0")
  privacyPolicyAccepted Boolean   @default(false)
  consentFormAccepted   Boolean   @default(false)
  acceptanceIpAddress   String?   // Legal proof of acceptance

  patients              Patient[]
  consultations         Consultation[]
  prescriptions         Prescription[]
  minutePurchases       MinutePurchase[]
  doctorMedicines       DoctorMedicine[]
  subscriptionHistory   DoctorSubscriptionHistory[]
  appointments          Appointment[]
  referralsGiven        Referral[]                 @relation("ReferralsGiven")
  referralsReceived     Referral[]                 @relation("ReferralsReceived")
  referralIncentives    ReferralIncentive[]
  appFeedback           AppFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Patient model (created by doctor, accessed via unique link)
model Patient {
  id       String  @id @default(uuid())
  doctorId String? // Optional for self-registered patients (APP_ACCOUNT)
  doctor   Doctor? @relation(fields: [doctorId], references: [id])

  fullName String
  phone    String?
  age      Int?
  gender   String?

  // Unique access token (used in shareable link)
  accessToken String @unique @default(uuid())

  // Track patient creation method
  createdVia String @default("MANUAL") // "MANUAL" | "SELF_REGISTERED"

  // Video call permissions (doctor can enable/disable per patient)
  videoCallEnabled Boolean @default(false) // Doctor must enable video calls for patient

  // Patient status for waitlist system
  status      String    @default("ACTIVE") // "ACTIVE" | "WAITLISTED"
  activatedAt DateTime? // When patient was moved from waitlist to active

  // Phase 2: Patient Authentication (OTP + PIN/Password)
  phoneVerified   Boolean   @default(false)
  password        String?   // 6-digit PIN or password (bcrypt hashed)
  lastOtpSent     DateTime?
  otpAttempts     Int       @default(0)
  otpLockedUntil  DateTime?
  refreshToken    String?   // For JWT refresh
  lastLoginAt     DateTime?
  accountType     String    @default("LINK_BASED") // "LINK_BASED" | "APP_ACCOUNT"

  // SECURITY: Terms & Conditions Acceptance (for APP_ACCOUNT patients)
  termsAcceptedAt       DateTime?
  termsVersion          String?
  privacyPolicyAccepted Boolean   @default(false)
  acceptanceIpAddress   String?   // Legal proof of acceptance

  consultations  Consultation[]
  vitals         Vitals[]
  medicalUploads MedicalUpload[]
  appointments   Appointment[]
  reminders      MedicineReminder[]
  referrals      Referral[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Consultation session (chat + video)
model Consultation {
  id        String  @id @default(uuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctorId  String
  doctor    Doctor  @relation(fields: [doctorId], references: [id])

  status      String   @default("ACTIVE") // ConsultationStatus
  startedAt   DateTime @default(now())
  completedAt DateTime?

  // Duration tracking (in seconds)
  duration        Int?     @default(0) // Total duration of consultation (for reference)
  videoDuration   Int?     @default(0) // Video call duration only (used for billing)
  wentOvertime    Boolean  @default(false) // Did consultation exceed available minutes?
  overtimeMinutes Int?     @default(0) // How many minutes over quota

  // Agora video
  agoraChannelName  String? @unique
  agoraDoctorToken  String?
  agoraPatientToken String?

  // Doctor notes
  chiefComplaint String?
  doctorNotes    String?

  // Unread message tracking
  lastMessageAt     DateTime?
  lastMessageSender String? // "doctor" | "patient"
  hasUnreadMessages Boolean  @default(false) // For doctor - updated when patient sends message

  chatMessages        ChatMessage[]
  prescription        Prescription?
  paymentConfirmation PaymentConfirmation?
  review              ConsultationReview?
  referrals           Referral[]     // Phase 2: Referrals originating from this consultation
  appointment         Appointment?   // Phase 2: Link to appointment if started from scheduled appointment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Chat messages (async messaging)
model ChatMessage {
  id             String       @id @default(uuid())
  consultationId String
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  senderType String // "doctor" or "patient"
  message    String

  // File attachments
  attachmentPath String? // Local file path
  attachmentType String? // image/pdf/etc

  // Read tracking for unread notifications
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([consultationId, createdAt])
  @@index([consultationId, isRead])
}

// Patient vitals data
model Vitals {
  id        String  @id @default(uuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  weight        Float?  // kg
  height        Float?  // cm
  bloodPressure String? // "120/80"
  temperature   Float?  // °C
  heartRate     Int?    // bpm
  oxygenLevel   Int?    // %

  notes String?

  createdAt DateTime @default(now())
}

// Medical reports/files uploaded by patient
model MedicalUpload {
  id        String  @id @default(uuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  filePath    String  // Local file path
  fileType    String  // image/pdf
  fileName    String
  description String?

  createdAt DateTime @default(now())
}

// Prescription generated by doctor
model Prescription {
  id             String       @id @default(uuid())
  consultationId String       @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  doctorId       String
  doctor         Doctor       @relation(fields: [doctorId], references: [id])

  serialNumber Int // Per-doctor sequential number

  diagnosis    String
  medications  String  // JSON string: Array of {name, dosage, frequency, duration}
  instructions String?

  pdfPath String? // Local file path of generated PDF

  reminders MedicineReminder[] // Phase 2: Medicine reminders for this prescription

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, serialNumber])
  @@index([doctorId, createdAt])
}

// Payment confirmation (manual by doctor)
model PaymentConfirmation {
  id             String       @id @default(uuid())
  consultationId String       @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  amount            Float
  confirmedByDoctor Boolean  @default(false)
  confirmedAt       DateTime?

  // Optional payment proof from patient
  proofImagePath String? // Screenshot of payment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Minute purchase transactions (buy extra video minutes)
model MinutePurchase {
  id       String @id @default(uuid())
  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id])

  minutes Int // Number of minutes purchased (100, 300, 500, 1000)
  price   Int // Price in paise (9900 for ₹99)

  // Razorpay payment details
  razorpayOrderId   String? @unique
  razorpayPaymentId String? @unique
  paymentStatus     String  @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Post-consultation patient reviews
model ConsultationReview {
  id             String       @id @default(uuid())
  consultationId String       @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  rating     Int     // 1-5 star rating
  reviewText String? // Optional text feedback

  createdAt DateTime @default(now())

  @@index([consultationId])
}

// Subscription plans configuration (for admin)
model SubscriptionPlan {
  id   String @id @default(uuid())
  tier String @unique // SubscriptionTier: "TRIAL" | "BASIC" | "PROFESSIONAL" | "ENTERPRISE"
  name String // Display name

  price               Int // Monthly price in paise (0 for trial)
  patientLimit        Int // Max patients (-1 for unlimited)
  monthlyVideoMinutes Int // Monthly video minutes quota

  // Marketing/Display data (JSON strings)
  features            String  // JSON array of feature strings
  suggestedFor        String? // JSON array of use case strings (marketing only)
  avgConsultationTime Int?    // Example avg time in minutes (marketing only)

  active Boolean @default(true)

  // Plan versioning
  version           Int      @default(1)
  effectiveFrom     DateTime @default(now())
  lastModifiedBy    String?  // Admin ID
  modificationNotes String?

  doctorSubscriptions DoctorSubscriptionHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Medicine database with categories
model Medicine {
  id   String @id @default(uuid())
  name String

  category String // MedicineCategory: "AYURVEDA" | "HOMEOPATHY" | "ALLOPATHY" | "UNANI" | "SIDDHA" | "GENERAL"

  genericName     String?
  manufacturer    String?
  dosageForms     String? // JSON: ["Tablet", "Syrup"]
  commonStrengths String? // JSON: ["500mg", "1g"]

  isVerified Boolean @default(false)
  isBanned   Boolean @default(false)

  restrictionNotes String?  // Why banned
  verifiedBy       String?  // Admin ID
  verifiedAt       DateTime?

  doctorMedicines DoctorMedicine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, category])
  @@index([category, isVerified, isBanned])
}

// Doctor's personal medicine list (many-to-many)
model DoctorMedicine {
  id         String   @id @default(uuid())
  doctorId   String
  doctor     Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  medicineId String
  medicine   Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)

  personalNotes String?
  usageCount    Int     @default(0) // Track frequency

  addedAt DateTime @default(now())

  @@unique([doctorId, medicineId])
  @@index([doctorId, usageCount])
}

// Subscription history (snapshot of plan at subscription time)
model DoctorSubscriptionHistory {
  id       String @id @default(uuid())
  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  tier                String
  pricePaid           Int    // Snapshot at time of subscription
  patientLimit        Int
  monthlyVideoMinutes Int
  features            String // JSON snapshot

  startedAt DateTime @default(now())
  endsAt    DateTime

  razorpayPaymentId      String?
  razorpaySubscriptionId String?

  status String @default("ACTIVE") // SubscriptionHistoryStatus: "ACTIVE" | "COMPLETED" | "CANCELLED"

  createdAt DateTime @default(now())

  @@index([doctorId, status])
  @@index([endsAt])
}

// Notification model (for in-app and email notifications)
model Notification {
  id        String   @id @default(uuid())

  // Recipient
  recipientType String  // "DOCTOR" | "ADMIN" | "PATIENT"
  recipientId   String  // User ID

  // Notification details
  type        String   // "DOCTOR_VERIFIED" | "DOCTOR_REJECTED" | "NEW_CHAT" | "DOCTOR_REPLY" | "PENDING_DOCTOR"
  title       String
  message     String

  // Optional action link
  actionUrl   String?
  actionText  String?

  // Metadata (JSON)
  metadata    String?  // Store additional data as JSON

  // Status
  isRead      Boolean  @default(false)
  readAt      DateTime?

  // Delivery tracking
  emailSent   Boolean  @default(false)
  emailSentAt DateTime?

  createdAt   DateTime @default(now())

  @@index([recipientType, recipientId, isRead])
  @@index([recipientType, recipientId, createdAt])
}

// Phase 2: Patient OTP storage
model PatientOtp {
  id        String   @id @default(uuid())
  phone     String
  otp       String   // Hashed OTP (bcrypt)
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone])
}

// Phase 2: Appointment Request System (Flexible, no time slots)
model Appointment {
  id                      String   @id @default(uuid())
  doctorId                String
  patientId               String

  // REQUEST PHASE - Patient submission
  requestedDate           DateTime  // Date patient wants appointment
  requestedTimePreference String?   // "MORNING" | "AFTERNOON" | "EVENING"
  reason                  String?   @db.Text // Patient's reason for appointment

  // RESPONSE PHASE - Doctor action
  scheduledTime           DateTime? // Confirmed time (null until accepted)
  proposedTime            DateTime? // Alternative time proposed by doctor
  proposedMessage         String?   @db.Text // Doctor's message with proposal
  rejectionReason         String?   @db.Text // Why doctor rejected

  // METADATA
  duration                Int      @default(30) // Minutes
  status                  String   @default("REQUESTED") // "REQUESTED" | "PROPOSED_ALTERNATIVE" | "CONFIRMED" | "REJECTED" | "CANCELLED" | "COMPLETED"
  consultationType        String   @default("VIDEO") // "VIDEO" | "CHAT" | "BOTH"
  consultationId          String?  @unique // Link to actual consultation when started

  // TIMESTAMPS
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  respondedAt             DateTime? // When doctor responded

  doctor       Doctor         @relation(fields: [doctorId], references: [id])
  patient      Patient        @relation(fields: [patientId], references: [id])
  consultation Consultation?  @relation(fields: [consultationId], references: [id])

  @@index([doctorId, status, requestedDate])
  @@index([patientId, status])
  @@index([doctorId, scheduledTime])
}

// System Settings - Global application configuration
model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique // Setting identifier (e.g., "ENABLE_PATIENT_SIGNUP")
  value     String   // Setting value (stored as string, parse as needed)
  type      String   @default("BOOLEAN") // "BOOLEAN" | "STRING" | "NUMBER" | "JSON"
  label     String   // Human-readable label for admin UI
  description String? @db.Text // Optional description
  category  String   @default("GENERAL") // "GENERAL" | "FEATURES" | "SECURITY" | "NOTIFICATIONS"
  updatedBy String?  // Admin ID who last updated
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
}

// Phase 2: Medicine Reminders
model MedicineReminder {
  id                  String                 @id @default(uuid())
  patientId           String
  prescriptionId      String
  medicineName        String
  dosage              String
  frequency           String                 // "ONCE_DAILY" | "TWICE_DAILY" | "THRICE_DAILY" | "CUSTOM"
  customSchedule      Json?                  // For custom timings: ["08:00", "14:00", "20:00"]
  startDate           DateTime
  endDate             DateTime
  isActive            Boolean                @default(true)
  notificationEnabled Boolean                @default(true)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  patient       Patient                @relation(fields: [patientId], references: [id])
  prescription  Prescription           @relation(fields: [prescriptionId], references: [id])
  adherenceLogs MedicineAdherenceLog[]

  @@index([patientId, isActive])
}

model MedicineAdherenceLog {
  id            String           @id @default(uuid())
  reminderId    String
  scheduledTime DateTime
  takenAt       DateTime?
  status        String           @default("PENDING") // "PENDING" | "TAKEN" | "MISSED" | "SKIPPED"
  createdAt     DateTime         @default(now())

  reminder MedicineReminder @relation(fields: [reminderId], references: [id])

  @@index([reminderId, scheduledTime])
}

// Phase 2: Referral System
model Referral {
  id                   String        @id @default(uuid())
  fromDoctorId         String
  toDoctorId           String?       // Specific doctor or null for patient to choose
  patientId            String
  consultationId       String        // Original consultation
  specialty            String?       // If toDoctorId null, suggest specialty
  reason               String        @db.Text
  urgency              String        @default("ROUTINE") // "URGENT" | "ROUTINE" | "FOLLOWUP"
  status               String        @default("PENDING") // "PENDING" | "ACCEPTED" | "COMPLETED" | "DECLINED"
  referralNotes        String?       @db.Text
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  fromDoctor           Doctor              @relation("ReferralsGiven", fields: [fromDoctorId], references: [id])
  toDoctor             Doctor?             @relation("ReferralsReceived", fields: [toDoctorId], references: [id])
  patient              Patient             @relation(fields: [patientId], references: [id])
  originalConsultation Consultation        @relation(fields: [consultationId], references: [id])
  incentive            ReferralIncentive?

  @@index([fromDoctorId])
  @@index([toDoctorId])
  @@index([patientId])
}

model ReferralIncentive {
  id                String   @id @default(uuid())
  referralId        String   @unique
  referringDoctorId String
  creditType        String   // "DISCOUNT" | "FREE_MINUTES" | "CASH"
  creditAmount      Int      // In paise or minutes
  status            String   @default("PENDING") // "PENDING" | "ISSUED" | "USED"
  issuedAt          DateTime?
  usedAt            DateTime?
  createdAt         DateTime @default(now())

  referral Referral @relation(fields: [referralId], references: [id])
  doctor   Doctor   @relation(fields: [referringDoctorId], references: [id])

  @@index([referringDoctorId, status])
}

// SECURITY: Audit Log for all sensitive operations
// Tracks: Login/Logout, Data Access, Prescription Creation, Payment Confirmation, Failed Logins
model AuditLog {
  id             String   @id @default(uuid())

  // Actor (who performed the action)
  actorType      String   // "DOCTOR" | "ADMIN" | "PATIENT" | "SYSTEM"
  actorId        String   // User ID
  actorEmail     String?  // For easy identification
  actorName      String?  // Full name

  // Action details
  action         String   // "LOGIN" | "LOGOUT" | "PRESCRIPTION_CREATE" | "PRESCRIPTION_DOWNLOAD" | "PAYMENT_CONFIRM" | "PATIENT_DATA_ACCESS" | "DOCTOR_VERIFY" | "DOCTOR_REJECT" | "FAILED_LOGIN" | "ADMIN_SETTINGS_CHANGE" | "CREATE_ADMIN" | "UPDATE_ADMIN" | "DELETE_ADMIN" | "ACTIVATE_ADMIN" | "DEACTIVATE_ADMIN"
  resourceType   String?  // "PATIENT" | "DOCTOR" | "PRESCRIPTION" | "PAYMENT" | "CONSULTATION"
  resourceId     String?  // ID of affected resource

  // Context
  description    String?  @db.Text // Human-readable description
  ipAddress      String?  // IP address of request
  userAgent      String?  @db.Text // Browser/device info
  metadata       Json?    // Additional context (old value, new value, etc.)

  // Success/Failure
  success        Boolean  @default(true)
  errorMessage   String?  @db.Text // If failed

  createdAt      DateTime @default(now())

  @@index([actorType, actorId, createdAt])
  @@index([action, createdAt])
  @@index([resourceType, resourceId])
  @@index([createdAt]) // For date-based queries
}

// SECURITY: Admin Access Log (specific to admin viewing patient/doctor data)
// Tracks admin accessing sensitive medical data with reason
model AdminAccessLog {
  id             String   @id @default(uuid())

  // Admin who accessed
  adminId        String
  adminEmail     String
  adminName      String

  // What was accessed
  accessType     String   // "PATIENT_VIEW" | "PATIENT_MEDICAL_DATA" | "DOCTOR_VIEW" | "CONSULTATION_VIEW" | "PRESCRIPTION_VIEW" | "PAYMENT_VIEW"
  resourceType   String   // "PATIENT" | "DOCTOR" | "CONSULTATION" | "PRESCRIPTION" | "PAYMENT"
  resourceId     String   // ID of accessed resource

  // Why accessed (REQUIRED)
  reason         String   // "LEGAL_REQUEST" | "DISPUTE_RESOLUTION" | "QUALITY_AUDIT" | "TECHNICAL_SUPPORT" | "USER_REQUEST"
  reasonDetails  String?  @db.Text // Additional explanation

  // Context
  ipAddress      String?
  userAgent      String?  @db.Text

  // What action was taken
  action         String   // "VIEW" | "EDIT" | "DELETE" | "EXPORT"

  accessedAt     DateTime @default(now())

  @@index([adminId, accessedAt])
  @@index([resourceType, resourceId, accessedAt])
  @@index([reason])
  @@index([accessedAt]) // For date-based queries and Google Sheets export
}

// SECURITY: Terms & Conditions Acceptance Log
model TermsAcceptance {
  id             String   @id @default(uuid())

  // User who accepted
  userType       String   // "DOCTOR" | "PATIENT" | "ADMIN"
  userId         String
  userEmail      String?

  // T&C details
  termsType      String   // "TERMS_AND_CONDITIONS" | "PRIVACY_POLICY" | "CONSENT_FORM"
  termsVersion   String   // "v1.0", "v2.0", etc.

  // Acceptance details
  acceptedAt     DateTime @default(now())
  ipAddress      String?  // Legal proof
  userAgent      String?  @db.Text

  @@index([userId, termsType])
  @@index([userType, acceptedAt])
}

// App Feedback from Doctors
// Doctors can submit feedback about the app to help us improve
model AppFeedback {
  id             String   @id @default(uuid())

  // Doctor who submitted feedback
  doctorId       String
  doctor         Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  // Feedback type
  type           String   // "FEATURE_REQUEST" | "BUG_REPORT" | "GENERAL_FEEDBACK" | "RATING"

  // Rating (1-5 stars)
  rating         Int?     // Optional for non-rating feedback

  // Feedback content
  title          String?  // Short title/subject
  description    String   @db.Text // Detailed feedback

  // Categories for better organization
  category       String?  // "UI/UX" | "PERFORMANCE" | "FEATURES" | "BUGS" | "OTHER"

  // Priority (if it's a bug/feature request)
  priority       String   @default("MEDIUM") // "LOW" | "MEDIUM" | "HIGH" | "CRITICAL"

  // Status tracking
  status         String   @default("PENDING") // "PENDING" | "ACKNOWLEDGED" | "IN_PROGRESS" | "RESOLVED" | "WONT_FIX"
  adminResponse  String?  @db.Text // Admin's response to the feedback

  // Metadata
  userAgent      String?  @db.Text
  deviceInfo     String?  @db.Text

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  resolvedAt     DateTime?

  @@index([doctorId, createdAt])
  @@index([type, status])
  @@index([status, createdAt])
  @@index([priority, status])
}
